# A2（パイプライン化後）: CSVタイミング検証（2025-08-29）

## 概要

- 目的: サンプリングとBLE送信の疎結合（協調的パイプライン）化による実効レート向上とΔt安定化の効果を確認。
- 実装要点:
  - 固定周期サンプリング: `SAMPLE_INTERVAL_MS=20`（約50Hz）でセンサー取得・CSV生成。
  - 送信は独立: `BLE_TX_INTERVAL_MS=40`でキューから2行/通知を送信（既存FIFO）。
  - 時間スライス: `BLE_BODY_SLICE_MS=15`でBLE書き込みを短枠化し、サンプリング優先。

## 記録ファイル

- パス: `receiver/recordings/2025-08-29/sensor_data_20250829_000058.csv`
- 行数: 1073（intervals=1072）
- 記録時間: 約29.0秒（duration_ms=29042）

## 解析コマンド

- 実行: `receiver/scripts/analyze_csv_timing.ps1 -Path <CSVパス>`
- 出力（抜粋）:
  - `delta_ms: avg=27.091 min=4 p50=20 p90=60 p95=84 p99=149 max=494`
  - `rate_hz: by_avg=36.913 by_span=36.912`
  - `jitter: over_40ms=168 (15.67% of intervals)`

## 所見

- 実効レートは約36.9 Hz。A1ベースライン（~20.1 Hz）→A2初回（~29.2 Hz）→本結果（~36.9 Hz）と段階的に改善。
- p50=20msに収束しており、固定周期サンプリングの効果が明確。p90=60ms・p95=84msは通知間の待ち・OSスケジューリングに由来。
- 最大494msの一時スパイクは稀発。40ms超割合は約15.7%と前回（~31.6%）より大幅減。
- 最小4msの短間隔は、まれにループが遅延した後の「キャッチアップ」挙動（次ループで早めに次サンプル生成）による可能性が高い。

## 考察 / 次アクション

- さらなる底上げ案（インターフェース不変）:
  - 3行/通知のバッチ化（FIFO既存・受信側は改行区切りで対応済み）。
  - `BLE_TX_INTERVAL_MS=30`等のABテスト（環境依存のため記録比較を推奨）。
  - MTU/PHY最適化（対応端末で2M PHY/MTU拡大）によりイベントあたりの実効容量を増やす。
- 観測の補助:
  - 送信側にキュー深さ/ドロップ統計・長大送信停滞（>300ms）カウンタを追加して原因切り分けを容易にする。

---

- 結論: パイプライン化により、Δtの中央値は20msに安定しつつ実効レートは~36.9 Hzまで向上。目標40Hz級に近づいており、3行/通知や送信間隔の微調整で更なる改善が見込める。
